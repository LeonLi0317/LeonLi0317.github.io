<!DOCTYPE html>
<html lang="zh-tw" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        //美金->台幣匯率換算fn
        function USDtoTWD() {
            let USD = $('#MASTER_CAP').val();
            $('#MASTER_CAP').val(numberComma(USD));
            let USPCNT = $('#USPCNT').val();
            let TWD =Math.round(Number(replaceComma(USD)) * USPCNT);
            $('#RATE').val(numberComma(TWD));
        };
        //字元擷取fn
        function LEFT(str, num) {
            return str.substring(0, num);
        };
        function RIGHT(str, num) {
            return str.substring(str.length - num, str.length);
        };

        //驗證小數點欄位 fn
        function numFloat(){
            $('.txtIncome').off().on('keypress',function(e){
                // 獲取字符
                var inputChar = String.fromCharCode(e.which);
                // 判斷輸入是否為數字或小數點
                if (!/^[0-9.]/.test(inputChar)) {
                    // 如果不是，阻止该字符的输入
                    e.preventDefault();
                }
                // 判斷小數點後是否超過兩位
                if (e.shiftKey && (e.which == 46 || e.which == 106)) { // 如果同时按下了shift键和點號鍵（.）或小鍵盤上的等號鍵（=），則允許輸入三位小數
                    e.preventDefault(); // 阻止输入
                }
                // 判斷總長度(含小數點)是否超過五位
                if ($(this).val().length >= 5) { // 如果超過5位數則停止
                    e.preventDefault(); // 停止
                }

            });

        };

        //試算 fn
        function Calculate() {
            $('#tbd2').empty();
            $('#tbd3').empty();
            let tbody = $('#tbd2');
            let B_M = 1;
            let E_M = 1;
            let USPCNT = $('#USPCNT').val();
            $('.txtMonth').each(function (index, value) {
                if (index == 0) {
                    let IncomePCNT = $('#txtIncome0').val();
                    IncomePCNT = '第 '+(Number(index)+1).toString()+' 期　年化收益：'+ IncomePCNT +'%';

                    let Mn = $(this).val();
                    let MASTER_CAP = $('#MASTER_CAP').val();
                    MASTER_CAP = replaceComma(MASTER_CAP);
                    let T_MASTER_CAP = MASTER_CAP.replace(RIGHT(MASTER_CAP, 4), '0000');
                    let PCNT = $(`#txtIncome${index}`).val();
                    PCNT = PCNT / 100;
                    let Income = Number(T_MASTER_CAP) * (PCNT / 12) * Number(Mn);
                    Income = Math.round(Income);
                    let Total = Number(MASTER_CAP) + Income;
                    let ToTWD = Math.round(Total * USPCNT);
                    let COST = $('#COST').val();
                    COST = replaceComma(COST);
                    COST = COST * Mn;
                    let finalTotalTWD = ToTWD-COST;
                    let finalTotalUSD = Math.round(finalTotalTWD / USPCNT);
                    //console.log(PCNT);
                    //console.log(Income);
                    tbody.append(`<tr><td colspan="9" style="text-align:center;" ><span style="font-weight:bold;color:darkmagenta;">${IncomePCNT}</span></td></tr>
                    <tr><td><span id="sp_Mn${index}">${"1~" + Mn + "月"}</span></td>
                    <td><span id="sp_MASTER_CAP${index}">${numberComma(MASTER_CAP)}</span></td>
                    <td><span id="sp_T_MASTER_CAP${index}">${numberComma(T_MASTER_CAP)}</span></td>
                    <td><span id="sp_Income${index}">${numberComma(Income)}</span></td>
                    <td><span id="sp_Total${index}">${numberComma(Total)}</span></td>
                    <td><span id="sp_ToTWD${index}">${numberComma(ToTWD)}</span></td>
                    <td><span id="sp_COST${index}">${numberComma(COST)}</span></td>
                    <td><span id="sp_finalTotalTWD${index}">${numberComma(finalTotalTWD)}</span></td>
                    <td><span id="sp_finalTotalUSD${index}">${numberComma(finalTotalUSD)}</span></td>
                    </tr>`)
                } else {
                    let IncomePCNT = $(`#txtIncome${index}`).val();
                    IncomePCNT = '第 '+(Number(index)+1).toString()+' 期　年化收益：'+ IncomePCNT +'%';
                    let Mn = $(this).val();
                    //console.log(Mn);
                    B_M = index - 1 == 0 ? Number(($(`#txtMonth${index - 1}`).val())) + 1 : E_M + 1;
                    E_M = Number($(`#txtMonth${index}`).val());
                    E_M = B_M + E_M - 1;
                    let MASTER_CAP = $(`#sp_finalTotalUSD${index - 1}`).text();
                    MASTER_CAP = replaceComma(MASTER_CAP);
                    //console.log(MASTER_CAP);
                    let T_MASTER_CAP = MASTER_CAP.replace(RIGHT(MASTER_CAP, 4), '0000');
                    let PCNT = $(`#txtIncome${index}`).val();
                    PCNT = PCNT / 100;
                    let Income = Number(T_MASTER_CAP) * (PCNT / 12) * Number(Mn);
                    Income = Math.round(Income);
                    let Total = Number(MASTER_CAP) + Income;
                    let ToTWD = Math.round(Total * USPCNT);
                    let COST = $('#COST').val();
                    COST = replaceComma(COST);
                    COST = COST * Mn;
                    let finalTotalTWD = ToTWD-COST;
                    let finalTotalUSD = Math.round(finalTotalTWD / USPCNT);

                    tbody.append(`<tr><td colspan="9" style="text-align:center;" ><span style="font-weight:bold;color:darkmagenta;">${IncomePCNT}</span></td></tr>
                    <tr><td><span id="sp_Mn${index}">${B_M + "~" + E_M + "月"}</span></td>
                    <td><span id="sp_MASTER_CAP${index}">${numberComma(MASTER_CAP)}</span></td>
                    <td><span id="sp_T_MASTER_CAP${index}">${numberComma(T_MASTER_CAP)}</span></td>
                    <td><span id="sp_Income${index}">${numberComma(Income)}</span></td>
                    <td><span id="sp_Total${index}">${numberComma(Total)}</span></td>
                    <td><span id="sp_ToTWD${index}">${numberComma(ToTWD)}</span></td>
                    <td><span id="sp_COST${index}">${numberComma(COST)}</span></td>
                    <td><span id="sp_finalTotalTWD${index}">${numberComma(finalTotalTWD)}</span></td>
                    <td><span id="sp_finalTotalUSD${index}">${numberComma(finalTotalUSD)}</span></td>
                    </tr>`)
                    //console.log(B_M);
                    //console.log(E_M);
                    let tbd = $('#tbd tr').length;
                    if(tbd == index +1 ){
                        let tbd3 = $('#tbd3');
                        let ORIMASTER_CAP = replaceComma($('#MASTER_CAP').val());
                        let totalwithoutCAPTWD = finalTotalUSD - Number(ORIMASTER_CAP);
                        let RATE = replaceComma($('#RATE').val());
                        let totalwithoutCAPUSD = finalTotalTWD - Number(RATE);
                        console.log(MASTER_CAP);
                        console.log(finalTotalUSD);
                        tbd3.append(`<tr><td class="table-warning"></td>
                            <td class="table-warning">總盈餘(美金)：${numberComma(totalwithoutCAPTWD)}</td>
                            <td class="table-danger"></td>
                            <td class="table-danger">總盈餘(台幣)：${numberComma(totalwithoutCAPUSD)}</td></tr>`);
                    }
                };
            });
        };
        //str轉換千分位
        function numberComma(num){
            let comma=/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g;
            return num.toString().replace(comma, ',');
        };
        //str千分位移除逗號
        function replaceComma(num){
            return num.replaceAll(',','');
        }


        $(document).ready(function () {
            //只允許輸入數字
            $('#MASTER_CAP,#COST').on('keypress',function(e){
                var inputvalue = e.which;
                if(inputvalue < 48 || inputvalue > 57){
                    e.preventDefault();
                }
            });
            //小數點限制
            numFloat();

            //加一筆資料 td
            $('#InsertRow').on('click', function () {
                let tbody = $('#tbd');
                let num = $('#tb').find('tbody').find('tr').length;
                tbody.append(`<tr><td class="txtID" style="width:1%">${num+1}</td>
                <td style="width:20%"><input type="number" maxlength="2" min="1" max="12" class="form-control form-control-sm NUM txtMonth" id="txtMonth${num}" placeholder="輸入期數"></td>
                <td style="width:20%"><input type="number" min="10" max="70" class="form-control form-control-sm NUM txtIncome" id="txtIncome${num}" placeholder="輸入(%)"></td></tr>`)
                //重新綁定監聽事件
                numFloat();
            });
            //減一筆資料 td
            $('#DeleteRow').on('click', function () {
                let tbody = $('#tb').find('tbody').find('tr');
                let num = $('#tb').find('tbody').find('tr').length;
                if (num != 1) {
                    tbody.eq(num - 1).remove();
                }
            });
            //清空+還原欄位 td
            $('#DeleteALL').on('click', function () {
                let tbody = $('#tbd,#tbd2,#tbd3').find('tr');
                let num = $('#tbd,#tbd2,#tbd3').find('tr').length;
                for (let i = 1; i <= num ; i++) {
                    tbody.eq(i).remove();
                }
                $('.NUM').val("");
            });
            //展出試算
            $('#Calculate').on('click', function () {
                var check = true;
                $('.NUM').each(function(index,value){
                    let txtbox = $(this).val();
                    if(txtbox==''){
                        alert('欄位不可為空，請填寫/刪減欄位。');
                        check = false;
                        return false;
                    }
                });
                if(check==false){
                    return false;
                }
                Calculate();
            });

            //欄位選取時移除逗號
            $('#MASTER_CAP,#COST').on('focus',function(){
                var val = $(this).val();
                $(this).val(replaceComma(val));
            });

            //本金檢核 必須超過1w
            $('#MASTER_CAP').on('blur',function(){
                let val = $('#MASTER_CAP').val();
                let USPCNT = $('#USPCNT').val();
                val = replaceComma(val);
                if(val==''){
                    return false;
                }
                if(USPCNT =='' && val!=''){
                    alert('請先輸入美金匯率');
                    $('#MASTER_CAP,#RATE').val("");
                    return false;
                }
                if(Number(val)<10000 && val !=''){
                    alert('本金不可以小於10,000美元');
                    $('#MASTER_CAP,#RATE').val("");
                    return false;
                }else{
                    USDtoTWD();
                }
            });
            $('#COST').on('blur',function(){
               let COST = $('#COST').val();
               COST = numberComma(COST);
               $('#COST').val(COST);
            });
        });
    </script>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <div class="row" style="padding-left:5%;padding-right:5%;padding-top:5%">
        <div class="col">
            <label for="US">美金匯率1：</label>
            <label for="USPCNT">
                <input type="text" class="form-control NUM" id="USPCNT" placeholder="比值" maxlength="4" style="width:35%" aria-label="USPCNT">
            </label>
        </div>
        <div class="col">
            <label for="exptre">每月開支(TWD)</label>
            <label for="COST">
                <input type="text" class="form-control NUM" id="COST" placeholder="輸入金額" aria-label="COST">
            </label>
        </div>
    </div>
    <div class="row" style="padding-left:5%;padding-right:5%;padding-top:10px">
        <div class="col">
            <label for="MASTER_CAP">
                投資本金(USD)
                <input type="text" class="form-control NUM" id="MASTER_CAP" placeholder="輸入本金" aria-label="MASTER_CAP">
            </label>
            ＝
            <label for="MASTER_CAP">
                換匯台幣(TWD)
                <input type="text" class="form-control NUM" id="RATE" placeholder="自動產生" aria-label="RATE" disabled="disabled">
            </label>
        </div>
    </div>
    <div class="row" style="padding-left:5%;padding-right:5%;padding-top:10px">
        <div class="row">
            <input class="btn btn-outline-primary" type="button" style="width:33.3%" id="InsertRow" value="加一筆資料" />
            <input class="btn btn-outline-secondary" type="button" style="width:33.3%" id="DeleteRow" value="減一筆資料" />
            <input class="btn btn-outline-danger" type="button" style="width:33.3%" id="DeleteALL" value="全部清除" />
        </div>
        <table class="table" id="tb" style="width:50%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>預計天期(月)</th>
                    <th>年化收益(%)</th>
                </tr>
            </thead>
            <tbody id="tbd">
                <tr>
                    <td class="txtID" style="width:1%">1</td>
                    <td style="width:20%"><input type="number" maxlength="2" min="1" max="12" class="form-control form-control-sm NUM txtMonth" id="txtMonth0" placeholder="輸入期數"></td>
                    <td style="width:20%"><input type="number" min="10" max="70" class="form-control form-control-sm NUM txtIncome" id="txtIncome0" placeholder="輸入(%)"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <br />
    <div class="row" style="padding-left:5%;padding-right:5%;padding-top:10px">
        <div class="row">
            <input class="btn btn-outline-success" type="button" style="width:100%" id="Calculate" value="開始試算" />
        </div>
        <table class="table table-striped table-hover caption-top" id="tb2" style="width:99%">
            <caption></caption>
            <thead>
                <tr>
                    <th>期迄</th>
                    <th>本金(USD)</th>
                    <th>實際投資金額(USD)</th>
                    <th>獲利(USD)</th>
                    <th>本+利息(USD)</th>
                    <th>換匯(TWD)</th>
                    <th>支出(TWD)</th>
                    <th>盈餘(TWD)</th>
                    <th>盈餘(USD)</th>
                </tr>
            </thead>
            <tbody id="tbd2"></tbody>
            <br>
        </table>
        <table class="table table-hover caption-top" id="tb3" style="width:99%">
            <caption></caption>
            <thead>
            </thead>
            <tbody id="tbd3"></tbody>
            <br>
        </table>
    </div>
</body>
</html>
